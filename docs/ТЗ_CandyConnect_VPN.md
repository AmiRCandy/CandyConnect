# Техническое задание (ТЗ)
## Проект: CandyConnect VPN

## 1. Цель доработки
Обновить функциональность панели управления VPN в части протоколов OpenVPN и WireGuard, а также заменить тип подключения DNSTT на Amnezia. Доработки должны повысить стабильность выдачи клиентских конфигов, улучшить UX подключения WireGuard и добавить поддержку нового типа подключения в backend, frontend и инфраструктуре установки.

---

## 2. Проблемы текущей версии
1. **OpenVPN**
   - Для новых клиентов не формируется/не выдается конфиг корректно.
   - В карточке нового клиента отображается `openvpn.config`, но элемент не кликабелен и не позволяет скачать файл.
2. **WireGuard**
   - Приватный ключ назначается автоматически сразу при создании клиента.
   - Нет явного действия пользователя для получения QR-кода/данных авторизации после создания клиента.
3. **DNSTT**
   - Протокол присутствует в системе, но должен быть полностью удален.
   - Вместо DNSTT требуется внедрить **Amnezia**.

---

## 3. Объем работ

### 3.1 OpenVPN: исправление генерации и выдачи конфигов
#### Функциональные требования
1. При создании нового OpenVPN-клиента система обязана:
   - генерировать валидный клиентский конфиг;
   - сохранять его в хранилище (файловое/БД — согласно текущей архитектуре);
   - отдавать ссылку/кнопку на скачивание в карточке клиента.
2. В карточке клиента элемент `openvpn.config` (или кнопка «Скачать конфиг») должен быть кликабельным.
3. По клику должен выполняться один из сценариев:
   - скачивание файла с корректным MIME/именем файла;
   - открытие модального окна с кнопкой скачивания (если так реализована UX-логика).
4. Для клиента, у которого конфиг отсутствует, должен отображаться понятный статус (например: «Конфиг не сгенерирован») и кнопка «Сгенерировать повторно» (опционально, но желательно).

#### Нефункциональные требования
- Время ответа API на выдачу ссылки/файла: до 2 сек при нормальной нагрузке.
- Корректная обработка ошибок (404, 500) с человекочитаемыми сообщениями в UI.

---

### 3.2 WireGuard: генерация QR по запросу
#### Функциональные требования
1. При создании нового WireGuard-клиента **не выполнять автогенерацию приватного ключа в интерфейсе как финальный шаг подключения**.
2. В профиле WireGuard-клиента после создания должна отображаться кнопка **«QR-код»**.
3. При нажатии кнопки:
   - формируется (или загружается, если уже есть) конфиг клиента;
   - генерируется QR-код на основе клиентского конфига;
   - QR отображается в модальном окне/отдельном блоке;
   - доступна кнопка «Скачать конфиг».
4. Должна быть защита от повторной гонки генерации (идемпотентность): повторные нажатия не должны ломать состояние клиента.

#### UX-требования
- Кнопка «QR-код» видна только для WireGuard-профилей.
- Во время генерации показывать индикатор загрузки.
- При ошибке — понятное сообщение (например: «Не удалось сгенерировать QR, попробуйте позже»).

---

### 3.3 Удаление DNSTT и внедрение Amnezia
#### Функциональные требования
1. Полностью удалить DNSTT из системы:
   - backend-модели/enum/роуты;
   - frontend-опции выбора типа подключения;
   - скрипты установки и конфигурации;
   - документацию и подсказки UI.
2. Добавить новый тип подключения **Amnezia**:
   - в основные настройки системы;
   - в настройки профилей;
   - в API (создание/чтение/обновление профилей);
   - в UI формы создания/редактирования.
3. Добавить установку необходимых пакетов для Amnezia в установочные скрипты (install/deploy/docker-образ при необходимости).
4. Реализовать проверку доступности зависимостей Amnezia после установки (health-check/валидация).

#### Инфраструктурные требования
- Новые пакеты должны устанавливаться без интерактивного ввода.
- Ошибки установки логируются и возвращаются в понятном виде.

---

## 4. Изменяемые компоненты (минимум)
- **Backend**: API клиентов, генерация конфигов, бизнес-логика протоколов, enum типов подключений.
- **Frontend (web-panel/client UI)**: карточка клиента, кнопки скачивания/QR, формы и настройки протоколов.
- **DevOps/Install**: install-скрипты, Dockerfile/docker-compose (если влияет), зависимости Amnezia.
- **Docs**: актуализация README/инструкций по подключению.

---

## 5. API/контракты (ожидаемые изменения)
1. Endpoint для скачивания OpenVPN-конфига должен стабильно возвращать файл.
2. Endpoint для WireGuard QR (новый или существующий) должен:
   - принимать `clientId`;
   - возвращать изображение/BASE64/URL QR;
   - возвращать статус генерации.
3. В типах протоколов удалить `DNSTT`, добавить `AMNEZIA`.

> Точные пути endpoint и форматы определяются текущей архитектурой проекта, но обратная совместимость для неизмененных методов должна быть сохранена.

---

## 6. Критерии приемки

### 6.1 OpenVPN
- [ ] Новый OpenVPN-клиент получает рабочий конфиг.
- [ ] В карточке клиента есть кликабельная кнопка/ссылка скачивания конфига.
- [ ] Конфиг скачивается и импортируется в OpenVPN-клиент без ошибок формата.

### 6.2 WireGuard
- [ ] После создания WireGuard-клиента отображается кнопка «QR-код».
- [ ] При нажатии отображается валидный QR для авторизации/импорта.
- [ ] Пользователь может скачать конфиг из того же интерфейса.

### 6.3 Amnezia
- [ ] DNSTT отсутствует в UI, API и установке.
- [ ] Amnezia доступна в основных настройках и настройках профиля.
- [ ] Установочные скрипты ставят необходимые пакеты Amnezia.
- [ ] Создание профиля с типом Amnezia проходит успешно.

---

## 7. Тестирование
1. **Unit tests**
   - генерация OpenVPN-конфига;
   - генерация WireGuard-QR;
   - валидация enum протоколов (без DNSTT, с Amnezia).
2. **Integration tests**
   - создание клиента + скачивание OpenVPN-конфига;
   - создание WireGuard-клиента + получение QR;
   - создание/редактирование Amnezia-профиля.
3. **UI/E2E tests**
   - кликабельность `openvpn.config`;
   - отображение и открытие кнопки «QR-код»;
   - отсутствие DNSTT и наличие Amnezia в селекторах.
4. **Smoke tests после деплоя**
   - проверка установки зависимостей Amnezia;
   - создание тестовых клиентов по каждому поддерживаемому типу.

---

## 8. Ограничения и риски
- Возможна миграция существующих данных, если DNSTT уже использовался в профилях.
- Возможны различия в пакетах Amnezia в зависимости от ОС/дистрибутива.
- Генерация QR должна учитывать безопасность: не логировать приватные ключи в открытом виде.

---

## 9. Ожидаемый результат
После выполнения доработок система CandyConnect VPN должна:
1. Корректно выдавать OpenVPN-конфиги новым клиентам.
2. Предоставлять WireGuard QR-код по нажатию кнопки в профиле клиента.
3. Полностью заменить DNSTT на Amnezia во всех слоях системы (UI/API/установка/настройки).
